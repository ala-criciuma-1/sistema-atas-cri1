{% extends "base.html" %}
{% block title %}Ata Sacramental{% endblock %}

{% block content %}
<div class="card" style="max-width: 1200px;">
  <h1>Ata de Reuni√£o Sacramental</h1>
  <p class="subtitle">Preencha os campos abaixo</p>

  <form method="POST">
    <input type="hidden" name="tipo" value="sacramental">
    <input type="hidden" name="data" value="{{ data }}">
    {% if editar %}
    <input type="hidden" name="editar" value="{{ editar }}">
    {% endif %}

    <!-- COLUNA ESQUERDA - DISCURSANTES E TEMAS RECENTES -->
    <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 2rem;">
      <div>
        {% if not editar and discursantes_recentes and discursantes_recentes|length > 0 %}
        <div style="background: #f8f9fa; padding: 1.5rem; border-radius: var(--radius); border-left: 4px solid var(--accent-color); margin-bottom: 2rem;">
          <h3 style="color: var(--accent-color); margin-bottom: 1rem;">üìã Discursantes Recentes</h3>
          <p style="font-size: 0.9rem; color: #666; margin-bottom: 1rem;">
            Discursantes dos √∫ltimos 3 meses:
          </p>
          <div style="max-height: 400px; overflow-y: auto;">
            <ul style="list-style: none; padding: 0; margin: 0;">
              {% for discursante in discursantes_recentes %}
              <li style="padding: 0.75rem; background: white; margin-bottom: 0.5rem; border-radius: 6px; border: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center;">
                <span style="font-weight: 500;">{{ discursante.nome }}</span>
                <small style="color: #666; font-size: 0.8rem;">{{ discursante.data }}</small>
              </li>
              {% endfor %}
            </ul>
          </div>
          <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e2e8f0;">
            <small style="color: #666;">
              üí° Dica: Voc√™ pode copiar os nomes para o formul√°rio ao lado
            </small>
          </div>
        </div>
        {% endif %}

        <!-- SE√á√ÉO: TEMAS RECENTES -->
        {% if not editar and temas_recentes and temas_recentes|length > 0 %}
        <div style="background: #f8f9fa; padding: 1.5rem; border-radius: var(--radius); border-left: 4px solid #0052cc;">
          <h3 style="color: #0052cc; margin-bottom: 1rem;">üìå Temas Recentes</h3>
          <p style="font-size: 0.9rem; color: #666; margin-bottom: 1rem;">
            Temas dos √∫ltimos 3 meses:
          </p>
          <div style="max-height: 300px; overflow-y: auto;">
            <ul style="list-style: none; padding: 0; margin: 0;">
              {% for tema in temas_recentes %}
              <li style="padding: 0.75rem; background: white; margin-bottom: 0.5rem; border-radius: 6px; border: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center;">
                <span style="font-weight: 500;">{{ tema.tema }}</span>
                <small style="color: #666; font-size: 0.8rem;">{{ tema.data }}</small>
              </li>
              {% endfor %}
            </ul>
          </div>
          <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e2e8f0;">
            <small style="color: #666;">
              üí° Voc√™ pode usar um tema j√° utilizado ou criar um novo
            </small>
          </div>
        </div>
        {% endif %}
        
        <!-- SE√á√ÉO: HINOS RECENTES -->

        {% if not editar and hinos_recentes and hinos_recentes|length > 0 %}
        <div style="background: #f8f9fa; padding: 1.5rem; border-radius: var(--radius); border-left: 4px solid #38c172; margin-top: 2rem;">
          <h3 style="color: #38c172; margin-bottom: 1rem;">üéµ Hinos Recentes</h3>
          <p style="font-size: 0.9rem; color: #666; margin-bottom: 1rem;">
            Hinos tocados nas reuni√µes dos √∫ltimos 2 meses, agrupados por data:
          </p>
          <div style="max-height: 300px; overflow-y: auto;">
            {% for ata_hinos in hinos_recentes %}
            <div style="margin-bottom: 1rem; padding: 0.75rem; background: white; border-radius: 6px; border: 1px solid #e2e8f0;">
              <p style="font-weight: 600; color: #38c172; margin: 0 0 0.5rem 0; border-bottom: 1px solid #eee;">
                Reuni√£o de {{ ata_hinos.data }}
              </p>
              <ul style="list-style: none; padding-left: 0; margin: 0;">
                {% for hino in ata_hinos.hinos %}
                <li style="font-size: 0.9rem; margin-bottom: 0.25rem; display: flex; justify-content: space-between;">
                  <span style="font-weight: 500;">{{ hino.tipo }}:</span> <span style="font-weight: 400;">{{ hino.nome }}</span>
                </li>
                {% endfor %}
              </ul>
            </div>
            {% endfor %}
          </div>
          <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e2e8f0;">
            <small style="color: #666;">
              üí° Use estes hinos para refer√™ncia.
            </small>
          </div>
        </div>
        {% endif %}
      </div>

      <!-- COLUNA DIREITA - FORMUL√ÅRIO ORGANIZADO EM SE√á√ïES -->
      <div>
        <!-- SE√á√ÉO BOAS VINDAS -->
        <div class="section" id="section1">
          <div class="section-header" onclick="toggleSection('section1')">
            <h3>BOAS VINDAS</h3>
            <span class="toggle-icon">‚ñº</span>
          </div>
          <div class="section-content">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
              <div>
                <label style="display:block; font-size:0.9rem; margin-bottom:0.3rem;">Presidido por</label>

                {% set presidido_is_outro = dados.presidido and dados.presidido not in [estaca.presidente|default(''), estaca.primeiro_conselheiro|default(''), estaca.segundo_conselheiro|default(''), unidade.bispo|default(''), unidade.primeiro_conselheiro|default(''), unidade.segundo_conselheiro|default('')] %}

                <select id="presidido_select" style="min-width:220px;">
                  {% if estaca.presidente %}
                  <optgroup label="Presidente Estaca">
                    <option value="{{ estaca.presidente }}" {% if dados.presidido == estaca.presidente %}selected{% endif %}>{{ estaca.presidente }}</option>
                  </optgroup>
                  {% endif %}

                  <optgroup label="Conselheiros da Estaca">
                    {% if estaca.primeiro_conselheiro %}<option value="{{ estaca.primeiro_conselheiro }}" {% if dados.presidido == estaca.primeiro_conselheiro %}selected{% endif %}>{{ estaca.primeiro_conselheiro }}</option>{% endif %}
                    {% if estaca.segundo_conselheiro %}<option value="{{ estaca.segundo_conselheiro }}" {% if dados.presidido == estaca.segundo_conselheiro %}selected{% endif %}>{{ estaca.segundo_conselheiro }}</option>{% endif %}
                  </optgroup>

                  <optgroup label="Bispo Unidade">
                    {% if unidade.bispo %}<option value="{{ unidade.bispo }}" {% if dados.presidido == unidade.bispo %}selected{% endif %}>{{ unidade.bispo }}</option>{% endif %}
                  </optgroup>
                  
                  <optgroup label="Conselheiros da Unidade">
                    {% if unidade.primeiro_conselheiro %}<option value="{{ unidade.primeiro_conselheiro }}" {% if dados.presidido == unidade.primeiro_conselheiro %}selected{% endif %}>{{ unidade.primeiro_conselheiro }}</option>{% endif %}
                    {% if unidade.segundo_conselheiro %}<option value="{{ unidade.segundo_conselheiro }}" {% if dados.presidido == unidade.segundo_conselheiro %}selected{% endif %}>{{ unidade.segundo_conselheiro }}</option>{% endif %}
                  </optgroup>

                  <option value="__outro__" {% if presidido_is_outro %}selected{% endif %}>Outro...</option>
                </select>

                <input type="text" id="presidido_outro" placeholder="Digite o nome se 'Outro'..." style="display:none; margin-top:0.5rem; width:100%; padding:0.5rem;">
                <input type="hidden" name="presidido" id="presidido_hidden" value="{{ dados.presidido or '' }}">
              </div>
              <div>
                <label style="display:block; font-size:0.9rem; margin-bottom:0.3rem;">Dirigido por</label>

                {% set dirigido_is_outro = dados.dirigido and dados.dirigido not in [estaca.presidente|default(''), estaca.primeiro_conselheiro|default(''), estaca.segundo_conselheiro|default(''), unidade.bispo|default(''), unidade.primeiro_conselheiro|default(''), unidade.segundo_conselheiro|default('')] %}

                <select id="dirigido_select" style="min-width:220px;">
                  {% if estaca.presidente %}
                  <optgroup label="Presidente Estaca">
                    <option value="{{ estaca.presidente }}" {% if dados.dirigido == estaca.presidente %}selected{% endif %}>{{ estaca.presidente }}</option>
                  </optgroup>
                  {% endif %}

                  <optgroup label="Conselheiros da Estaca">
                    {% if estaca.primeiro_conselheiro %}<option value="{{ estaca.primeiro_conselheiro }}" {% if dados.dirigido == estaca.primeiro_conselheiro %}selected{% endif %}>{{ estaca.primeiro_conselheiro }}</option>{% endif %}
                    {% if estaca.segundo_conselheiro %}<option value="{{ estaca.segundo_conselheiro }}" {% if dados.dirigido == estaca.segundo_conselheiro %}selected{% endif %}>{{ estaca.segundo_conselheiro }}</option>{% endif %}
                  </optgroup>

                  <optgroup label="Bispo Unidade">
                    {% if unidade.bispo %}<option value="{{ unidade.bispo }}" {% if dados.dirigido == unidade.bispo %}selected{% endif %}>{{ unidade.bispo }}</option>{% endif %}
                  </optgroup>

                  <optgroup label="Conselheiros da Unidade">
                    {% if unidade.primeiro_conselheiro %}<option value="{{ unidade.primeiro_conselheiro }}" {% if dados.dirigido == unidade.primeiro_conselheiro %}selected{% endif %}>{{ unidade.primeiro_conselheiro }}</option>{% endif %}
                    {% if unidade.segundo_conselheiro %}<option value="{{ unidade.segundo_conselheiro }}" {% if dados.dirigido == unidade.segundo_conselheiro %}selected{% endif %}>{{ unidade.segundo_conselheiro }}</option>{% endif %}
                  </optgroup>

                  <option value="__outro__" {% if dirigido_is_outro %}selected{% endif %}>Outro...</option>
                </select>

                <input type="text" id="dirigido_outro" placeholder="Digite o nome se 'Outro'..." style="display:none; margin-top:0.5rem; width:100%; padding:0.5rem;">
                <input type="hidden" name="dirigido" id="dirigido_hidden" value="{{ dados.dirigido or '' }}">
              </div>
              <div>
                <label style="display:block; font-size:0.9rem; margin-bottom:0.3rem;">Como recepcionista(s)</label>
                <input type="text" name="recepcionistas" value="{{ dados.recepcionistas or '' }}">
              </div>
              <div>
                <label style="display:block; font-size:0.9rem; margin-bottom:0.3rem;">Pianista</label>
                <input type="text" name="pianista" value="{{ dados.pianista or '' }}">
              </div>
              <div>
                <label style="display:block; font-size:0.9rem; margin-bottom:0.3rem;">Regente de M√∫sica</label>
                <input type="text" name="regente_musica" value="{{ dados.regente_musica or '' }}">
              </div>
              <div style="grid-column: 1 / -1;">
                <label style="display:block; font-size:0.9rem; margin-bottom:0.3rem;">
                  <i class="fas fa-tag"></i> Tema da Reuni√£o (Opcional)
                </label>
                <input type="text" name="tema" value="{{ dados.tema or '' }}" placeholder="Ex: Obra Mission√°ria, A Restaura√ß√£o e Fam√≠lia">
                <small style="display:block; margin-top:0.5rem; color:#666; font-size:0.875rem;">
                  üí° Defina um tema principal para esta reuni√£o sacramental
                </small>
              </div>
            </div>
          </div>
        </div>

        <!-- SE√á√ÉO ABERTURA -->
        <div class="section" id="section2">
          <div class="section-header" onclick="toggleSection('section2')">
            <h3>ABERTURA</h3>
            <span class="toggle-icon">‚ñº</span>
          </div>
          <div class="section-content">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
              <div style="grid-column: 1 / -1;">
                <label style="display:block; font-size:0.9rem; margin-bottom:0.3rem;">Reconhecemos a Presen√ßa</label>
                <textarea name="reconhecemos_presenca" rows="3" style="width:100%; border-radius:var(--radius); padding:0.75rem; border:1px solid #ccc; font-family:inherit;" placeholder="Digite aqui as pessoas/entidades cuja presen√ßa √© reconhecida">{{ dados.reconhecemos_presenca or '' }}</textarea>
              </div>
              <div style="grid-column: 1 / -1;">
                <label style="display:block; font-size:0.9rem; margin-bottom:0.3rem;">An√∫ncios</label>
                <textarea name="anuncios[]" rows="3" style="width:100%; border-radius:var(--radius); padding:0.75rem; border:1px solid #ccc; font-family:inherit;" placeholder="Digite os an√∫ncios, um por linha">{{ dados.anuncios|join('\n') if dados.anuncios else '' }}</textarea>
              </div>
              <div>
                <label style="display:block; font-size:0.9rem; margin-bottom:0.3rem;">Hino de Abertura</label>
                <input type="text" name="hino_abertura" value="{{ dados.hino_abertura or '' }}">
              </div>
              <div>
                <label style="display:block; font-size:0.9rem; margin-bottom:0.3rem;">Ora√ß√£o de Abertura</label>
                <input type="text" name="oracao_abertura" value="{{ dados.oracao_abertura or '' }}">
              </div>
            </div>
          </div>
        </div>

        <!-- SE√á√ÉO A√á√ïES -->
        <div class="section" id="section3">
          <div class="section-header" onclick="toggleSection('section3')">
            <h3>A√á√ïES</h3>
            <span class="toggle-icon">‚ñº</span>
          </div>
          <div class="section-content">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
              <!-- Desobriga√ß√µes -->
              <div style="grid-column: 1 / -1;">
                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.5rem;">
                  <input type="checkbox" id="incluir_desobrigacoes" name="incluir_desobrigacoes" onchange="toggleField('desobrigacoes', this.checked)">
                  <label for="incluir_desobrigacoes" style="font-weight: 600; color: var(--accent-color);">Incluir Desobriga√ß√µes</label>
                </div>
                <div id="desobrigacoes-field" style="display: none;">
                  <textarea name="desobrigacoes" rows="3" style="width:100%; border-radius:var(--radius); padding:0.75rem; border:1px solid #ccc; font-family:inherit;" placeholder="Digite as desobriga√ß√µes">{{ dados.desobrigacoes or '' }}</textarea>
                </div>
              </div>

              <!-- Apoios -->
              <div style="grid-column: 1 / -1;">
                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.5rem;">
                  <input type="checkbox" id="incluir_apoios" name="incluir_apoios" onchange="toggleField('apoios', this.checked)">
                  <label for="incluir_apoios" style="font-weight: 600; color: var(--accent-color);">Incluir Apoios</label>
                </div>
                <div id="apoios-field" style="display: none;">
                  <textarea name="apoios" rows="3" style="width:100%; border-radius:var(--radius); padding:0.75rem; border:1px solid #ccc; font-family:inherit;" placeholder="Digite os apoios">{{ dados.apoios or '' }}</textarea>
                </div>
              </div>

              <!-- Confirma√ß√µes Batismais -->
              <div style="grid-column: 1 / -1;">
                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.5rem;">
                  <input type="checkbox" id="incluir_confirmacoes" name="incluir_confirmacoes" onchange="toggleField('confirmacoes_batismo', this.checked)">
                  <label for="incluir_confirmacoes" style="font-weight: 600; color: var(--accent-color);">Incluir Confirma√ß√µes Batismais</label>
                </div>
                <div id="confirmacoes_batismo-field" style="display: none;">
                  <textarea name="confirmacoes_batismo" rows="3" style="width:100%; border-radius:var(--radius); padding:0.75rem; border:1px solid #ccc; font-family:inherit;" placeholder="Digite as confirma√ß√µes batismais">{{ dados.confirmacoes_batismo or '' }}</textarea>
                </div>
              </div>

              <!-- Apoio a Novos Membros -->
              <div style="grid-column: 1 / -1;">
                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.5rem;">
                  <input type="checkbox" id="incluir_apoio_membros" name="incluir_apoio_membros" onchange="toggleField('apoio_membros', this.checked)">
                  <label for="incluir_apoio_membros" style="font-weight: 600; color: var(--accent-color);">Incluir Apoio a Novos Membros</label>
                </div>
                <div id="apoio_membros-field" style="display: none;">
                  <textarea name="apoio_membros" rows="3" style="width:100%; border-radius:var(--radius); padding:0.75rem; border:1px solid #ccc; font-family:inherit;" placeholder="Digite o apoio a novos membros">{{ dados.apoio_membros or '' }}</textarea>
                </div>
              </div>

              <!-- Ben√ß√£o de Crian√ßas -->
              <div style="grid-column: 1 / -1;">
                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.5rem;">
                  <input type="checkbox" id="incluir_bencao" name="incluir_bencao" onchange="toggleField('bencao_criancas', this.checked)">
                  <label for="incluir_bencao" style="font-weight: 600; color: var(--accent-color);">Incluir Ben√ß√£o de Crian√ßas</label>
                </div>
                <div id="bencao_criancas-field" style="display: none;">
                  <textarea name="bencao_criancas" rows="3" style="width:100%; border-radius:var(--radius); padding:0.75rem; border:1px solid #ccc; font-family:inherit;" placeholder="Digite as b√™n√ß√£os de crian√ßas">{{ dados.bencao_criancas or '' }}</textarea>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- SE√á√ÉO SACRAMENTO -->
        <div class="section" id="section4">
          <div class="section-header" onclick="toggleSection('section4')">
            <h3>SACRAMENTO</h3>
            <span class="toggle-icon">‚ñº</span>
          </div>
          <div class="section-content">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
              <div>
                <label style="display:block; font-size:0.9rem; margin-bottom:0.3rem;">Hino Sacramental</label>
                <input type="text" name="hino_sacramental" value="{{ dados.hino_sacramental or '' }}">
              </div>
            </div>
          </div>
        </div>

        <!-- SE√á√ÉO MENSAGENS -->
        <div class="section" id="section5">
          <div class="section-header" onclick="toggleSection('section5')">
            <h3>MENSAGENS</h3>
            <span class="toggle-icon">‚ñº</span>
          </div>
          <div class="section-content">
            <!-- Discursantes -->
            <div style="margin-bottom: 2rem; padding: 1.5rem; background: #f8f9fa; border-radius: var(--radius);">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h4 style="color: var(--accent-color); margin: 0;">Discursantes</h4>
                <button type="button" onclick="addDiscursante()" style="background: #666; color: white; border: none; padding: 0.5rem 1rem; border-radius: var(--radius); cursor: pointer; font-size: 0.9rem;">
                  + Adicionar Discursante
                </button>
              </div>
              
              <div id="discursantes-container">
                {% if dados.discursantes and dados.discursantes|length > 0 %}
                  {% for discursante in dados.discursantes %}
                    {% if discursante and discursante.strip() %}
                    <div class="discursante-field">
                      <input type="text" name="discursantes[]" value="{{ discursante }}" placeholder="Nome do discursante">
                      <button type="button" onclick="removeDiscursante(this)" class="remove-btn">√ó</button>
                    </div>
                    {% endif %}
                  {% endfor %}
                {% else %}
                  <!-- Campos iniciais -->
                  <div class="discursante-field"> 
                    <input type="text" name="discursantes[]" placeholder="1¬∫ Discursante">
                    <button type="button" onclick="removeDiscursante(this)" class="remove-btn">√ó</button>
                  </div>
                  <div class="discursante-field">
                    <input type="text" name="discursantes[]" placeholder="2¬∫ Discursante">
                    <button type="button" onclick="removeDiscursante(this)" class="remove-btn">√ó</button>
                  </div>
                {% endif %}
              </div>
            </div>

            <!-- Hino Intermedi√°rio -->
            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
              <input type="checkbox" id="incluir_hino_intermediario" name="incluir_hino_intermediario" onchange="toggleField('hino_intermediario', this.checked)" {% if dados.hino_intermediario %}checked{% endif %}>
              <label for="incluir_hino_intermediario" style="font-weight: 600; color: var(--accent-color);">Incluir Hino Intermedi√°rio</label>
            </div>
            <div id="hino_intermediario-field" style="{% if not dados.hino_intermediario %}display: none;{% endif %} margin-bottom: 1rem;">
              <input type="text" name="hino_intermediario" value="{{ dados.hino_intermediario or '' }}" placeholder="Hino Intermedi√°rio">
            </div>
          </div>
        </div>

        <!-- SE√á√ÉO AGRADECIMENTOS FINAIS -->
        <div class="section" id="section6">
          <div class="section-header" onclick="toggleSection('section6')">
            <h3>AGRADECIMENTOS FINAIS</h3>
            <span class="toggle-icon">‚ñº</span>
          </div>
          <div class="section-content">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
              <div>
                <label style="display:block; font-size:0.9rem; margin-bottom:0.3rem;">√öltimo Discursante</label>
                <input type="text" name="ultimo_discursante" value="{{ dados.ultimo_discursante or '' }}">
              </div>
            </div>
          </div>
        </div>

        <!-- SE√á√ÉO ENCERRAMENTO -->
        <div class="section" id="section7">
          <div class="section-header" onclick="toggleSection('section7')">
            <h3>ENCERRAMENTO</h3>
            <span class="toggle-icon">‚ñº</span>
          </div>
          <div class="section-content">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
              <div>
                <label style="display:block; font-size:0.9rem; margin-bottom:0.3rem;">Hino de Encerramento</label>
                <input type="text" name="hino_encerramento" value="{{ dados.hino_encerramento or '' }}">
              </div>
              <div>
                <label style="display:block; font-size:0.9rem; margin-bottom:0.3rem;">Ora√ß√£o de Encerramento</label>
                <input type="text" name="oracao_encerramento" value="{{ dados.oracao_encerramento or '' }}">
              </div>
            </div>
          </div>
        </div>

        <!-- BOT√ïES DE A√á√ÉO -->
        <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-top: 2rem;">
          <button type="submit" style="flex:1; min-width:200px; padding:0.75rem 1rem; border-radius:var(--radius); background:#0e0067; color:#fff; text-decoration:none; text-align:center; font-size:1rem;">
            <i class="fa fa-save"></i> {% if editar %}Atualizar{% else %}Salvar{% endif %} Ata
          </button>
          {% if editar %}
          <a href="{{ url_for('visualizar_ata', ata_id=editar) }}" style="flex:1; min-width:200px; padding:0.75rem 1rem; border-radius:var(--radius); background:#999; color:#fff; text-decoration:none; text-align:center;">
            <i class="fa fa-reply"></i> Voltar
          </a>
          {% else %}
          <a href="{{ url_for('nova_ata') }}" style="flex:1; min-width:200px; padding:0.75rem 1rem; border-radius:var(--radius); background:#666; color:#fff; text-decoration:none; text-align:center;">
            <i class="fa fa-clipboard"></i> Nova Ata
          </a>
          <a href="{{ url_for('index') }}" style="flex:1; min-width:200px; padding:0.75rem 1rem; border-radius:var(--radius); background:#999; color:#fff; text-decoration:none; text-align:center;">
            <i class="fa fa-folder"></i> Cancelar
          </a>
          {% endif %}
        </div>
      </div>
    </div>
  </form>
</div>

<script>
let discursanteCount = {{ dados.discursantes|length if dados.discursantes else 2 }};

// Fun√ß√£o para alternar se√ß√µes
function toggleSection(sectionId) {
  const section = document.getElementById(sectionId);
  const content = section.querySelector('.section-content');
  const icon = section.querySelector('.toggle-icon');
  
  if (content.style.display === 'none') {
    content.style.display = 'block';
    icon.textContent = '‚ñº';
  } else {
    content.style.display = 'none';
    icon.textContent = '‚ñ∂';
  }
}

// Fun√ß√£o para alternar campos opcionais
function toggleField(fieldName, show) {
  const field = document.getElementById(fieldName + '-field');
  if (field) {
    field.style.display = show ? 'block' : 'none';
  }
}

// Fun√ß√µes para discursantes
function addDiscursante() {
  const container = document.getElementById('discursantes-container');
  const newDiv = document.createElement('div');
  newDiv.className = 'discursante-field';
  
  discursanteCount++;
  
  const input = document.createElement('input');
  input.type = 'text';
  input.name = 'discursantes[]';
  input.placeholder = discursanteCount + '¬∫ Discursante';
  
  const button = document.createElement('button');
  button.type = 'button';
  button.className = 'remove-btn';
  button.textContent = '√ó';
  button.onclick = function() { removeDiscursante(this); };
  
  newDiv.appendChild(input);
  newDiv.appendChild(button);
  container.appendChild(newDiv);
}

function removeDiscursante(button) {
  const container = document.getElementById('discursantes-container');
  const inputs = container.querySelectorAll('input[name="discursantes[]"]');
  
  // S√≥ remove se houver mais de um campo
  if (inputs.length > 1) {
    button.parentElement.remove();
    // Atualiza os placeholders
    updateDiscursantePlaceholders();
  }
}

function updateDiscursantePlaceholders() {
  const inputs = document.querySelectorAll('input[name="discursantes[]"]');
  inputs.forEach(function(input, index) {
    input.placeholder = (index + 1) + '¬∫ Discursante';
  });
  discursanteCount = inputs.length;
}

// Inicializar se√ß√µes fechadas (exceto a primeira)
document.addEventListener('DOMContentLoaded', function() {
  // Fechar todas as se√ß√µes exceto a primeira
  for (let i = 2; i <= 7; i++) {
    const section = document.getElementById('section' + i);
    if (section) {
      const content = section.querySelector('.section-content');
      const icon = section.querySelector('.toggle-icon');
      content.style.display = 'none';
      icon.textContent = '‚ñ∂';
    }
  }
});
</script>

<script>
(function(){
  // Se o markup novo (selects com esses ids) j√° existe, n√£o rodamos o script antigo.
  if (document.getElementById('presidido_select') || document.getElementById('dirigido_select')) {
    return;
  }
  // Se quiser reaproveitar o script antigo com IDs diferentes, implemente aqui.
})();
</script>

<script>
(function(){
  const estaca = {{ estaca|default({})|tojson }};
  const unidade = {{ unidade|default({})|tojson }};
  const dados_presidido = "{{ dados.presidido|default('')|escape }}";
  const dados_dirigido = "{{ dados.dirigido|default('')|escape }}";

  function setHidden(id, v){ const h = document.getElementById(id); if(h) h.value = v || ''; }

  function buildOptions(arr){
    if(!arr || !Array.isArray(arr)) return [];
    return arr.filter(Boolean).map(v=>({value:v,label:v}));
  }

  function createSelect(opts, id){
    const sel = document.createElement('select');
    sel.id = id;
    sel.style.width = '100%';
    sel.style.padding = '0.45rem';
    const empty = document.createElement('option'); empty.value=''; empty.textContent='-- selecione --';
    sel.appendChild(empty);
    opts.forEach(o=>{ const opt=document.createElement('option'); opt.value=o.value; opt.textContent=o.label; sel.appendChild(opt); });
    return sel;
  }

  function showControl(type, targetPrefix){
    const controls = document.getElementById(targetPrefix + '_controls');
    const hiddenId = targetPrefix + '_hidden';
    controls.innerHTML = '';

    if(type === 'presidente_estaca'){
      const input = document.createElement('input'); input.type='text'; input.disabled=true; input.value = estaca && estaca.presidente ? estaca.presidente : '';
      input.style.width='100%'; input.style.padding='0.45rem';
      controls.appendChild(input);
      setHidden(hiddenId, input.value);
    } else if(type === 'conselheiro_estaca'){
      const opts = buildOptions([ estaca && estaca.primeiro_conselheiro, estaca && estaca.segundo_conselheiro ]);
      const sel = createSelect(opts, targetPrefix + '_conselheiro_estaca');
      sel.onchange = ()=> setHidden(hiddenId, sel.value);
      controls.appendChild(sel);
      const hv = document.getElementById(hiddenId).value;
      if(hv) sel.value = hv;
    } else if(type === 'bispo_unidade'){
      const input = document.createElement('input'); input.type='text'; input.disabled=true; input.value = unidade && unidade.bispo ? unidade.bispo : '';
      input.style.width='100%'; input.style.padding='0.45rem';
      controls.appendChild(input);
      setHidden(hiddenId, input.value);
    } else if(type === 'conselheiro_unidade'){
      const opts = buildOptions([ unidade && unidade.primeiro_conselheiro, unidade && unidade.segundo_conselheiro ]);
      const sel = createSelect(opts, targetPrefix + '_conselheiro_unidade');
      sel.onchange = ()=> setHidden(hiddenId, sel.value);
      controls.appendChild(sel);
      const hv = document.getElementById(hiddenId).value;
      if(hv) sel.value = hv;
    } else { // outro
      const input = document.createElement('input'); input.type='text'; input.placeholder='Digite o nome...';
      input.style.width='100%'; input.style.padding='0.45rem';
      input.oninput = ()=> setHidden(hiddenId, input.value);
      controls.appendChild(input);
      const hv = document.getElementById(hiddenId).value;
      if(hv) input.value = hv;
    }
  }

  function detectSourceByValue(value){
    if(!value) return null;
    if(estaca && estaca.presidente && estaca.presidente === value) return 'presidente_estaca';
    if(estaca && estaca.primeiro_conselheiro && estaca.primeiro_conselheiro === value) return 'conselheiro_estaca';
    if(estaca && estaca.segundo_conselheiro && estaca.segundo_conselheiro === value) return 'conselheiro_estaca';
    if(unidade && unidade.bispo && unidade.bispo === value) return 'bispo_unidade';
    if(unidade && unidade.primeiro_conselheiro && unidade.primeiro_conselheiro === value) return 'conselheiro_unidade';
    if(unidade && unidade.segundo_conselheiro && unidade.segundo_conselheiro === value) return 'conselheiro_unidade';
    return 'outro';
  }

  function setSourceOptionText(selectEl){
    if(!selectEl) return;
    const optPres = selectEl.querySelector('option[value="presidente_estaca"]');
    const optConsEst = selectEl.querySelector('option[value="conselheiro_estaca"]');
    const optBispo = selectEl.querySelector('option[value="bispo_unidade"]');
    const optConsUn = selectEl.querySelector('option[value="conselheiro_unidade"]');

    if(optPres) optPres.textContent = (estaca && estaca.presidente) ? (estaca.presidente) : 'Presidente de Estaca';
    if(optBispo) optBispo.textContent = (unidade && unidade.bispo) ? (unidade.bispo) : 'Bispo da Unidade';

    // conselheiros: mostrar lista ou r√≥tulo
    const consEstNames = [estaca && estaca.primeiro_conselheiro, estaca && estaca.segundo_conselheiro].filter(Boolean);
    if(optConsEst) optConsEst.textContent = consEstNames.length ? ('Conselheiros: ' + consEstNames.join(' / ')) : 'Conselheiro da Estaca';

    const consUnNames = [unidade && unidade.primeiro_conselheiro, unidade && unidade.segundo_conselheiro].filter(Boolean);
    if(optConsUn) optConsUn.textContent = consUnNames.length ? ('Conselheiros: ' + consUnNames.join(' / ')) : 'Conselheiro da Unidade';
  }

  document.addEventListener('DOMContentLoaded', function(){
    const srcPres = document.getElementById('presidido_source');
    const srcDir = document.getElementById('dirigido_source');

    // Atualiza os textos das op√ß√µes para mostrar nomes reais quando dispon√≠veis
    setSourceOptionText(srcPres);
    setSourceOptionText(srcDir);

    // tentativa de auto sele√ß√£o com base no valor salvo
    const autoPres = detectSourceByValue(dados_presidido);
    const autoDir = detectSourceByValue(dados_dirigido);

    if(autoPres) { srcPres.value = autoPres; showControl(autoPres, 'presidido'); }
    else { showControl(srcPres.value, 'presidido'); }

    if(autoDir) { srcDir.value = autoDir; showControl(autoDir, 'dirigido'); }
    else { showControl(srcDir.value, 'dirigido'); }

    // listeners
    srcPres.addEventListener('change', ()=> showControl(srcPres.value, 'presidido'));
    srcDir.addEventListener('change', ()=> showControl(srcDir.value, 'dirigido'));
  });
})();
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // PRESIDIDO
  const presSelect = document.getElementById('presidido_select');
  const presHidden = document.getElementById('presidido_hidden');
  const presOutro = document.getElementById('presidido_outro');

  function syncPresidido() {
    const v = presSelect.value;
    if (v === '__outro__') {
      presOutro.style.display = 'block';
      presHidden.value = presOutro.value || '';
    } else {
      presOutro.style.display = 'none';
      presHidden.value = v;
    }
  }

  presSelect && presSelect.addEventListener('change', syncPresidido);
  presOutro && presOutro.addEventListener('input', () => presHidden.value = presOutro.value);

  // inicializa√ß√£o: se o hidden tem valor que n√£o est√° entre as op√ß√µes, mostrar outro
  (function initPres(){
    const hv = presHidden.value || '';
    let found = false;
    if (presSelect) {
      for (let i = 0; i < presSelect.options.length; i++) {
        if (presSelect.options[i].value === hv) { presSelect.selectedIndex = i; found = true; break; }
      }
      if (!found && hv) {
        presSelect.value = '__outro__';
        presOutro.style.display = 'block';
        presOutro.value = hv;
        presHidden.value = hv;
      } else {
        syncPresidido();
      }
    }
  })();

  // DIRIGIDO
  const dirSelect = document.getElementById('dirigido_select');
  const dirHidden = document.getElementById('dirigido_hidden');
  const dirOutro = document.getElementById('dirigido_outro');

  function syncDirigido() {
    const v = dirSelect.value;
    if (v === '__outro__') {
      dirOutro.style.display = 'block';
      dirHidden.value = dirOutro.value || '';
    } else {
      dirOutro.style.display = 'none';
      dirHidden.value = v;
    }
  }

  dirSelect && dirSelect.addEventListener('change', syncDirigido);
  dirOutro && dirOutro.addEventListener('input', () => dirHidden.value = dirOutro.value);

  (function initDir(){
    const hv = dirHidden.value || '';
    let found = false;
    if (dirSelect) {
      for (let i = 0; i < dirSelect.options.length; i++) {
        if (dirSelect.options[i].value === hv) { dirSelect.selectedIndex = i; found = true; break; }
      }
      if (!found && hv) {
        dirSelect.value = '__outro__';
        dirOutro.style.display = 'block';
        dirOutro.value = hv;
        dirHidden.value = hv;
      } else {
        syncDirigido();
      }
    }
  })();
});
</script>

<style>
@media (max-width: 768px) {
  .card > form > div {
    grid-template-columns: 1fr !important;
  }
}

/* Estilo para scrollbar da lista de discursantes recentes */
div[style*="max-height: 400px"]::-webkit-scrollbar {
  width: 6px;
}

div[style*="max-height: 400px"]::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 3px;
}

div[style*="max-height: 400px"]::-webkit-scrollbar-thumb {
  background: #c1c1c1;
  border-radius: 3px;
}

div[style*="max-height: 400px"]::-webkit-scrollbar-thumb:hover {
  background: #a8a8a8;
}

/* Estilo das se√ß√µes */
.section {
  margin-bottom: 1rem;
  border: 1px solid #e2e8f0;
  border-radius: var(--radius);
  overflow: hidden;
}

.section-header {
  background: var(--accent-color);
  color: white;
  padding: 1rem 1.5rem;
  cursor: pointer;
  display: flex;
  justify-content: space-between;
  align-items: center;
  transition: background 0.2s ease;
}

.section-header:hover {
  background: #00335b;
}

.section-header h3 {
  margin: 0;
  color: white;
  font-size: 1.1rem;
}

.toggle-icon {
  font-weight: bold;
  transition: transform 0.2s ease;
}

.section-content {
  padding: 1.5rem;
  background: white;
}

/* Estilo dos campos de discursantes */
.discursante-field {
  margin-bottom: 1rem;
  display: flex;
  gap: 0.5rem;
  align-items: center;
}

.discursante-field input {
  flex: 1;
  padding: 0.75rem;
  font-size: 1rem;
  height: 48px;
  border: 1px solid #ccc;
  border-radius: var(--radius);
}

.remove-btn {
  background: #dc3545;
  color: white;
  border: none;
  width: 36px;
  height: 36px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 1rem;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  transition: background 0.2s ease;
}

.remove-btn:hover {
  background: #c82333;
}

/* Estilo para checkboxes */
input[type="checkbox"] {
  width: auto;
  margin: 0;
}
</style>
{% endblock %}